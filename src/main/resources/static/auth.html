<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Auth Demo (GraphQL)</title>
    <style>
      :root {
        color-scheme: light;
      }
      body {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        margin: 24px;
        line-height: 1.4;
        background: #fafafa;
        color: #111827;
      }
      .container {
        max-width: 980px;
        margin: 0 auto;
      }
      header {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        gap: 12px;
        margin-bottom: 16px;
      }
      h2 {
        margin: 0;
        font-size: 20px;
      }
      .muted {
        color: #6b7280;
        font-size: 13px;
      }
      .grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
      }
      @media (max-width: 900px) {
        .grid {
          grid-template-columns: 1fr;
        }
      }
      .card {
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 16px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
      }
      label {
        display: block;
        margin: 10px 0 6px;
        font-size: 13px;
        color: #374151;
      }
      input {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        font-size: 14px;
      }
      button {
        margin-top: 12px;
        padding: 10px 14px;
        border: 1px solid #111827;
        background: #111827;
        color: white;
        border-radius: 10px;
        cursor: pointer;
        font-size: 14px;
      }
      button.secondary {
        border-color: #e5e7eb;
        background: #fff;
        color: #111827;
      }
      .row {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
      }
      pre {
        background: #0b1020;
        color: #d6e0ff;
        padding: 12px;
        overflow: auto;
        border-radius: 12px;
        border: 1px solid #111827;
        min-height: 180px;
      }
      code {
        font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      }
      .note {
        margin: 10px 0 0;
        font-size: 13px;
        color: #6b7280;
      }
      .pill {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 999px;
        border: 1px solid #e5e7eb;
        font-size: 12px;
        color: #374151;
        background: #fff;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h2>로그인 / 회원가입 (GraphQL 데모)</h2>
        <div class="muted">
          endpoint:
          <code id="endpoint"></code>
        </div>
      </header>

      <div class="card" style="margin-bottom: 16px">
        <div class="row" style="justify-content: space-between">
          <div>
            <span class="pill">session</span>
            <span class="muted" id="sessionText">로그인 상태 아님</span>
          </div>
          <div class="row">
            <button class="secondary" id="btnLogout" type="button">Logout</button>
            <button class="secondary" id="btnWhoami" type="button">Who am I?</button>
          </div>
        </div>
        <p class="note">
          현재 서버 스키마에는 “진짜 로그인(비밀번호/토큰 발급)” 뮤테이션이 없어서, 이 페이지의
          로그인 섹션은 <code>user(id)</code>로 조회해서 “로그인처럼” 저장하는 데모입니다.
          회원가입은 <code>createUser</code>로 실제 생성됩니다.
        </p>
      </div>

      <div class="grid">
        <div class="card">
          <h3 style="margin: 0 0 6px">회원가입</h3>
          <div class="muted">mutation: <code>createUser(username, email)</code></div>

          <label for="suUsername">username</label>
          <input id="suUsername" placeholder="mkk" autocomplete="off" />

          <label for="suEmail">email</label>
          <input id="suEmail" placeholder="mkk@example.com" autocomplete="off" />

          <button id="btnSignup" type="button">Sign up</button>
        </div>

        <div class="card">
          <h3 style="margin: 0 0 6px">로그인(데모)</h3>
          <div class="muted">query: <code>user(id)</code></div>

          <label for="liUserId">user id</label>
          <input id="liUserId" placeholder="1" inputmode="numeric" autocomplete="off" />

          <button id="btnLogin" type="button">Login</button>
        </div>
      </div>

      <div class="card" style="margin-top: 16px">
        <h3 style="margin: 0 0 10px">Result</h3>
        <pre id="out"></pre>
      </div>
    </div>

    <script>
      const outEl = document.getElementById("out");
      const endpointEl = document.getElementById("endpoint");
      const sessionTextEl = document.getElementById("sessionText");

      const graphqlUrl =
        location.protocol === "file:" ? "http://localhost:8080/graphql" : "/graphql";
      endpointEl.textContent = graphqlUrl;

      function setOut(obj) {
        outEl.textContent =
          typeof obj === "string" ? obj : JSON.stringify(obj, null, 2);
      }

      function setSession(user) {
        if (user) {
          localStorage.setItem("session.user", JSON.stringify(user));
        } else {
          localStorage.removeItem("session.user");
        }
        renderSession();
      }

      function getSession() {
        try {
          const raw = localStorage.getItem("session.user");
          return raw ? JSON.parse(raw) : null;
        } catch {
          return null;
        }
      }

      function renderSession() {
        const u = getSession();
        sessionTextEl.textContent = u
          ? `로그인됨: ${u.username} (${u.email}, id=${u.id})`
          : "로그인 상태 아님";
      }

      async function gql(query, variables) {
        const res = await fetch(graphqlUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ query, variables }),
        });
        const text = await res.text();
        try {
          return JSON.parse(text);
        } catch {
          return { raw: text };
        }
      }

      function pickDataOrThrow(json) {
        if (json?.errors?.length) {
          const msg = json.errors.map((e) => e.message).join("\n");
          throw new Error(msg);
        }
        return json.data;
      }

      document.getElementById("btnSignup").addEventListener("click", async () => {
        const username = document.getElementById("suUsername").value.trim();
        const email = document.getElementById("suEmail").value.trim();
        if (!username || !email) {
          setOut("username/email을 입력해줘");
          return;
        }

        const query = `mutation CreateUser($username: String!, $email: String!) {
  createUser(username: $username, email: $email) { id username email }
}`;

        setOut("Loading...");
        try {
          const json = await gql(query, { username, email });
          const data = pickDataOrThrow(json);
          setSession(data.createUser);
          setOut(json);
        } catch (e) {
          setOut(String(e));
        }
      });

      document.getElementById("btnLogin").addEventListener("click", async () => {
        const id = document.getElementById("liUserId").value.trim();
        if (!id) {
          setOut("user id를 입력해줘");
          return;
        }

        const query = `query User($id: ID!) {
  user(id: $id) { id username email }
}`;

        setOut("Loading...");
        try {
          const json = await gql(query, { id });
          const data = pickDataOrThrow(json);
          if (!data.user) {
            setOut({ ...json, note: "user(id)가 null이라 로그인 실패(데모)" });
            return;
          }
          setSession(data.user);
          setOut(json);
        } catch (e) {
          setOut(String(e));
        }
      });

      document.getElementById("btnLogout").addEventListener("click", () => {
        setSession(null);
        setOut("Logged out");
      });

      document.getElementById("btnWhoami").addEventListener("click", async () => {
        const u = getSession();
        if (!u?.id) {
          setOut("세션이 비어있어");
          return;
        }
        const query = `query User($id: ID!) {
  user(id: $id) { id username email }
}`;
        setOut("Loading...");
        try {
          const json = await gql(query, { id: u.id });
          setOut(json);
        } catch (e) {
          setOut(String(e));
        }
      });

      renderSession();
      setOut("Ready");
    </script>
  </body>
</html>

