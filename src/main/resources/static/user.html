<!doctype html>
<html lang="ko">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>User</title>
        <link rel="stylesheet" href="app.css" />
        <style>
            h2 {
                margin: 0 0 4px;
                font-size: 22px;
                letter-spacing: -0.02em;
            }
            /* make profile header feel like a hero */
            #username {
                letter-spacing: -0.02em;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="card">
                <div class="row">
                    <div>
                        <h2 style="margin: 0 0 4px">User profile</h2>
                        <div class="muted">팔로우/팔로워 카운트 + 팔로우/언팔로우</div>
                    </div>
                    <div class="row2">
                        <button id="btnBack" type="button">Back</button>
                    </div>
                </div>

                <div class="muted" style="margin-top: 10px">
                    me: <code id="meInline"></code>
                </div>

                <div id="out" class="muted" style="margin-top: 12px"></div>

                <div style="margin-top: 12px">
                    <div class="row">
                        <div>
                            <div style="font-weight: 700; font-size: 18px" id="username"></div>
                            <div class="muted" id="email"></div>
                        </div>
                        <div class="row2">
                            <span class="pill">followers: <span id="followersCount">0</span></span>
                            <span class="pill">following: <span id="followingCount">0</span></span>
                            <button id="btnFollow" class="primary" type="button">Follow</button>
                            <button id="btnUnfollow" class="danger" type="button">Unfollow</button>
                        </div>
                    </div>
                </div>

                <div class="row2" style="margin-top: 14px">
                    <button id="btnLoadFollowers" type="button">Load followers</button>
                    <button id="btnLoadFollowing" type="button">Load following</button>
                </div>

                <div class="list" id="list"></div>
            </div>
        </div>

        <script>
            const graphqlUrl = location.protocol === "file:" ? "http://localhost:8080/graphql" : "/graphql";

            function getSession() {
                const raw = localStorage.getItem("session.user");
                if (!raw) return null;
                try {
                    return JSON.parse(raw);
                } catch {
                    return null;
                }
            }

            function getToken() {
                return localStorage.getItem("session.token");
            }

            async function gql(query, variables) {
                const token = getToken();
                const headers = { "Content-Type": "application/json" };
                if (token) headers["Authorization"] = "Bearer " + token;
                const res = await fetch(graphqlUrl, {
                    method: "POST",
                    headers,
                    body: JSON.stringify({ query, variables }),
                });
                const text = await res.text();
                try {
                    return JSON.parse(text);
                } catch {
                    return { raw: text };
                }
            }

            function pickDataOrThrow(json) {
                if (json?.errors?.length) {
                    const msg = json.errors.map((e) => e.message).join("\n");
                    throw new Error(msg);
                }
                return json.data;
            }

            function escapeHtml(s) {
                return String(s)
                    .replaceAll("&", "&amp;")
                    .replaceAll("<", "&lt;")
                    .replaceAll(">", "&gt;")
                    .replaceAll('"', "&quot;")
                    .replaceAll("'", "&#039;");
            }

            const meInlineEl = document.getElementById("meInline");
            const outEl = document.getElementById("out");
            const usernameEl = document.getElementById("username");
            const emailEl = document.getElementById("email");
            const followersCountEl = document.getElementById("followersCount");
            const followingCountEl = document.getElementById("followingCount");
            const btnFollow = document.getElementById("btnFollow");
            const btnUnfollow = document.getElementById("btnUnfollow");
            const listEl = document.getElementById("list");

            document.getElementById("btnBack").addEventListener("click", () => {
                location.href = "/blog.html";
            });

            const me = getSession();
            meInlineEl.textContent = me ? `${me.id} (${me.username})` : "(anonymous)";

            const params = new URLSearchParams(location.search);
            const userId = (params.get("id") ?? "").trim();

            async function loadProfile() {
                if (!userId) {
                    outEl.textContent = "id 파라미터가 없어. 예) /user.html?id=1";
                    return;
                }

                const query = `
                    query UserProfile($id: ID!, $userId: ID!) {
                        user(id: $id) { id username email }
                        followersCount(userId: $userId)
                        followingCount(userId: $userId)
                        isFollowing(userId: $userId)
                    }
                `;
                const json = await gql(query, { id: userId, userId });
                const data = pickDataOrThrow(json);

                usernameEl.textContent = data.user?.username ?? "(no user)";
                emailEl.textContent = data.user?.email ?? "";
                followersCountEl.textContent = String(data.followersCount ?? 0);
                followingCountEl.textContent = String(data.followingCount ?? 0);

                const mine = me && String(me.id) === String(userId);
                btnFollow.style.display = mine ? "none" : "inline-block";
                btnUnfollow.style.display = mine ? "none" : "inline-block";

                const isFollowing = !!data.isFollowing;
                btnFollow.disabled = isFollowing;
                btnUnfollow.disabled = !isFollowing;

                outEl.textContent = "";
            }

            async function follow() {
                const q = `
                    mutation Follow($userId: ID!) {
                        followUser(userId: $userId)
                    }
                `;
                const json = await gql(q, { userId });
                pickDataOrThrow(json);
                await loadProfile();
            }

            async function unfollow() {
                const q = `
                    mutation Unfollow($userId: ID!) {
                        unfollowUser(userId: $userId)
                    }
                `;
                const json = await gql(q, { userId });
                pickDataOrThrow(json);
                await loadProfile();
            }

            btnFollow.addEventListener("click", () => {
                follow().catch((e) => (outEl.textContent = String(e)));
            });
            btnUnfollow.addEventListener("click", () => {
                unfollow().catch((e) => (outEl.textContent = String(e)));
            });

            async function loadFollowers() {
                const q = `
                    query Followers($userId: ID!) {
                        followers(userId: $userId) { id username }
                    }
                `;
                const json = await gql(q, { userId });
                const data = pickDataOrThrow(json);
                renderUserList("followers", data.followers ?? []);
            }

            async function loadFollowing() {
                const q = `
                    query Following($userId: ID!) {
                        following(userId: $userId) { id username }
                    }
                `;
                const json = await gql(q, { userId });
                const data = pickDataOrThrow(json);
                renderUserList("following", data.following ?? []);
            }

            function renderUserList(title, users) {
                listEl.innerHTML = "";
                const head = document.createElement("div");
                head.className = "muted";
                head.textContent = `${title}: ${users.length}`;
                listEl.appendChild(head);

                for (const u of users) {
                    const div = document.createElement("div");
                    div.className = "item";
                    div.innerHTML = `
                        <div style="font-weight: 600; margin-bottom: 6px">${escapeHtml(u.username ?? "")}</div>
                        <div class="muted">
                            <a class="pill" style="text-decoration:none" href="/user.html?id=${encodeURIComponent(
                                String(u.id),
                            )}">id: ${escapeHtml(String(u.id))}</a>
                        </div>
                    `;
                    listEl.appendChild(div);
                }
            }

            document.getElementById("btnLoadFollowers").addEventListener("click", () => {
                loadFollowers().catch((e) => (outEl.textContent = String(e)));
            });
            document.getElementById("btnLoadFollowing").addEventListener("click", () => {
                loadFollowing().catch((e) => (outEl.textContent = String(e)));
            });

            loadProfile().catch((e) => (outEl.textContent = String(e)));
        </script>
    </body>
</html>

